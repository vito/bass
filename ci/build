#!/usr/bin/env bass

(use (*dir*/bass))

(def [ref] *args*)

(def src
  (bass:checkout ref))

(def linux-binary
  (bass:build src "linux" "amd64"))

(defn test-version [image]
  (run (from image
         ($ $linux-binary --version)))

  (if (succeeds? (from image
                   ($ ldd $linux-binary)))
    (error "binary is not statically linked")
    :ok))

(map test-version [(linux/ubuntu) (linux/alpine)])

(emit linux-binary *stdout*)

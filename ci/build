#!/usr/bin/env bass

(use (*dir*/bass))

(def [ref] *args*)

(def src
  (bass:checkout ref))

(def linux-binary
  (bass:build src "linux" "amd64"))

(defn test-version [image]
  (let [ldd (from image
              ($ $linux-binary --version)
              (-> ($ ldd $linux-binary)
                  (response-from :exit)))
        dynamic? (= 0 (next (ldd)))]
    (if dynamic?
      (error "binary is not statically linked")
      :ok)))


(map test-version [(linux/ubuntu) (linux/alpine)])

(emit linux-binary *stdout*)

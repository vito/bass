#!/usr/bin/env bass

; load libraries
(def bass    (load (*dir*/bass)))
(def release (load (*dir*/release)))

; ref: git ref to tag (can be symbolic, i.e. HEAD)
;
; tag: tag to push for the release
;
; name: a name for the release
(def [ref tag name]
  (case *args*
    ; default name to tag
    [r t] [r t t]

    _ *args*))

; resolve the ref to an actual commit
(def version
  (next (bass:repo:check-every 1 ref)))

(logf "shipping bass @ %s with tag %s" version tag)

(def src
  (bass:repo:get version))

; cross-compile binaries
;
; TODO: no Windows yet; need to fix the unix socket/pgrp shenanigans
(def binaries
  [(bass:build src "linux" "amd64")
   (bass:build src "darwin" "amd64")])

; publish GitHub release
(let [res (release:publish binaries version tag name)]
  (log res))

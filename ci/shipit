#!/usr/bin/env bass

; sha: git sha to tag
;
; tag: tag name to create
;
; title: a name for the release
(def [sha tag title]
  (case *args*
    ; default title to tag
    [s t] [s t t]

    _ *args*))

; load libraries
(def bass
  (load (*dir*/bass)))

(def project
  (load (*dir*/../project)))

; fetch the repo at the given sha
(def src
  (bass:checkout sha))

; cross-compile binaries
;
; TODO: no Windows yet; need to fix the unix socket/pgrp shenanigans
(def binaries
  [(bass:build src "linux" "amd64")
   (bass:build src "darwin" "amd64")])

; publish GitHub release
(logf "publishing bass @ %s to tag %s" sha tag)
(log project:release:create!)
(log (project:release:create! tag sha binaries {:title title}))

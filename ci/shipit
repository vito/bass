#!/usr/bin/env bass

; load libraries
(use (.git (linux/alpine/git))
     (*dir*/../project)
     (*dir*/bass)
     (git:github/vito/tabs/ref/main/gh/release))

(def *github-token*
  (make-secret :github-token *env*:GITHUB_TOKEN))

; sha: git sha to tag
;
; tag: tag name to create
;
; title: a name for the release
(def [sha tag title]
  (case *args*
    ; default title to tag
    [s t] [s t t]

    _ *args*))

; fetch the repo at the given sha
(def src
  (bass:checkout sha))

; cross-compile binaries
;
; TODO: no Windows yet; need to fix the unix socket/pgrp shenanigans
(def binaries
  [(bass:build src "linux" "amd64")
   (bass:build src "darwin" "amd64")])

(def bass-release
  (release:auth "vito/bass" *github-token*))

; publish GitHub release
(logf "publishing bass @ %s to tag %s" sha tag)

(def release-url
  (bass-release:create!
    tag sha binaries
    {:title title
     :generate-notes true
     :prerelease true}))

(log release-url)

#!/usr/bin/env bass

; load libraries
(use (.git "alpine/git")
     (*dir*/../project)
     (*dir*/../secrets)
     (*dir*/bass))
     ; (git:github/vito/bass/main/gh/release "vito/bass" secrets:*access-token*)

(def release
  (let [repo "https://github.com/vito/tabs"
        tabs (git:checkout repo (git:ls-remote repo "main"))]
    (load (tabs/gh/release "vito/bass" secrets:*access-token*))))

; sha: git sha to tag
;
; tag: tag name to create
;
; title: a name for the release
(def [sha tag title]
  (case *args*
    ; default title to tag
    [s t] [s t t]

    _ *args*))

; fetch the repo at the given sha
(def src
  (bass:checkout sha))

; cross-compile binaries
;
; TODO: no Windows yet; need to fix the unix socket/pgrp shenanigans
(def binaries
  [(bass:build src "linux" "amd64")
   (bass:build src "darwin" "amd64")])

; publish GitHub release
(logf "publishing bass @ %s to tag %s" sha tag)
(log (release:create! tag sha binaries {:title title}))

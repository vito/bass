#!/usr/bin/env bass

; load libraries
(use (.git (linux/alpine/git))
     (git:github/vito/tabs/ref/main/gh/release)
     (*dir*/../project))

(defn parse-args [args]
  (case args
    ; default 3rd arg (title) to tag
    [sha tag] [sha tag tag]

    ; let it fail at pattern-match time
    _ args))

(defn main args
  (def *github-token*
    (make-secret :github-token *env*:GITHUB_TOKEN))

  (def bass-release
    (release:auth "vito/bass" *github-token*))

  (let [[sha   ; git sha to tag
         tag   ; tag name to create
         title ; name for the release
         ] (parse-args args)
        src (project:checkout sha)
        assets [(project:build src "linux" "amd64")
                (project:build src "darwin" "amd64")
                (project:build src "darwin" "arm64")]]
  (logf "publishing bass @ %s to tag %s" sha tag)
  (log
    (bass-release:create!
      tag sha assets
      {:title title
       :generate-notes true
       :prerelease true}))))
